<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Browser Automation - Visual Workflow Editor v2.0</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Enhanced Visual Workflow Editor Styles */
        .workflow-editor {
            position: relative;
            height: 85vh;
            min-height: 750px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="1" cy="1" r="1" fill="%23d1d5db"/></svg>') repeat;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .workflow-editor.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999;
            border-radius: 0;
            border: none;
        }

        /* Enhanced Sidebar with New Node Categories */
        .workflow-sidebar {
            position: absolute;
            left: 0;
            top: 0;
            width: 300px;
            height: 100%;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-right: 2px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
            z-index: 20;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .workflow-sidebar.collapsed { transform: translateX(-100%); }

        .workflow-sidebar h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 60px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 25;
            transition: all 0.3s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
        }

        .sidebar-toggle:hover { background: #2563eb; width: 36px; }
        .sidebar-toggle i { transition: transform 0.3s ease; }
        .workflow-sidebar.collapsed + .sidebar-toggle i { transform: rotate(180deg); }

        /* Enhanced Node Palette with New Categories */
        .node-palette { display: grid; gap: 12px; }
        .palette-section { margin-bottom: 24px; }
        .palette-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .palette-section-title i {
            font-size: 14px;
            width: 16px;
        }

        .palette-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.25s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 13px;
        }

        .palette-item:hover {
            background: #f1f5f9;
            border-color: var(--category-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .palette-item:active { cursor: grabbing; transform: translateY(0); }
        .palette-item i { 
            margin-right: 10px; 
            font-size: 14px; 
            width: 18px; 
            text-align: center;
            color: var(--category-color);
        }
        .palette-item span { font-weight: 500; color: #374151; }

        /* Category Color Variables */
        .palette-item.basic { --category-color: #3b82f6; }
        .palette-item.navigation { --category-color: #8b5cf6; }
        .palette-item.interaction { --category-color: #10b981; }
        .palette-item.keyboard { --category-color: #f59e0b; }
        .palette-item.data { --category-color: #ef4444; }
        .palette-item.control { --category-color: #06b6d4; }
        .palette-item.file { --category-color: #84cc16; }

        /* Enhanced Properties Panel */
        .node-properties {
            position: absolute;
            right: 0;
            top: 0;
            width: 370px;
            height: 100%;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border-left: 2px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
            z-index: 20;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .node-properties.collapsed { transform: translateX(100%); }

        .properties-toggle {
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 60px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 25;
            transition: all 0.3s ease;
            box-shadow: -2px 0 8px rgba(0,0,0,0.2);
        }

        .properties-toggle:hover { background: #059669; width: 36px; }
        .properties-toggle i { transition: transform 0.3s ease; }
        .node-properties.collapsed + .properties-toggle i { transform: rotate(180deg); }

        .node-properties h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Enhanced Property Fields */
        .property-group {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .property-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }

        .property-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.25s ease;
            background: #ffffff;
        }

        .property-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .property-input:invalid { border-color: #ef4444; }
        .property-input[type="checkbox"] { width: auto; margin-right: 8px; transform: scale(1.1); }
        .property-input[type="textarea"] { min-height: 80px; resize: vertical; }

        .property-help {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
        }

        /* Enhanced Floating Toolbar */
        .workflow-toolbar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            height: 60px;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 12px;
            z-index: 30;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .toolbar-btn {
            padding: 8px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: #ffffff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .toolbar-btn.active {
            background: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }

        .toolbar-separator { width: 1px; height: 30px; background: #e5e7eb; }

        .workflow-stats {
            display: flex;
            gap: 16px;
            margin-left: auto;
            font-size: 12px;
            color: #6b7280;
        }

        .workflow-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        /* Enhanced Canvas Layout */
        .workflow-canvas {
            position: absolute;
            top: 0;
            left: 300px;
            right: 370px;
            height: 100%;
            overflow: hidden;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .workflow-canvas:active { cursor: grabbing; }
        .workflow-editor.sidebar-collapsed .workflow-canvas { left: 0; }
        .workflow-editor.properties-collapsed .workflow-canvas { right: 0; }
        .workflow-editor.both-collapsed .workflow-canvas { left: 0; right: 0; }

        .canvas-container {
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            transition: transform 0.1s ease;
        }

        /* Enhanced Workflow Nodes */
        .workflow-node {
            position: absolute;
            min-width: 200px;
            max-width: 280px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 10;
            transition: all 0.25s ease;
            font-size: 13px;
        }

        .workflow-node:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .workflow-node.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .workflow-node.start-node {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }

        /* Node Type Specific Styles */
        .workflow-node.type-navigation {
            border-left: 4px solid #8b5cf6;
        }

        .workflow-node.type-interaction {
            border-left: 4px solid #10b981;
        }

        .workflow-node.type-keyboard {
            border-left: 4px solid #f59e0b;
        }

        .workflow-node.type-data {
            border-left: 4px solid #ef4444;
        }

        .workflow-node.type-control {
            border-left: 4px solid #06b6d4;
        }

        .workflow-node.type-file {
            border-left: 4px solid #84cc16;
        }

        .node-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }

        .node-header i { 
            margin-right: 10px; 
            font-size: 16px; 
            color: #6366f1; 
            width: 18px;
            text-align: center;
        }

        .start-node .node-header { color: #92400e; }
        .start-node .node-header i { color: #f59e0b; }

        .node-content {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        /* Enhanced Connection Points */
        .node-connection {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: crosshair;
            border: 3px solid #ffffff;
            transition: all 0.25s ease;
            z-index: 15;
        }

        .node-connection:hover { 
            transform: scale(1.4); 
            box-shadow: 0 0 16px rgba(0,0,0,0.4); 
        }

        .node-connection.connecting { 
            animation: connection-pulse 1.5s infinite; 
            transform: scale(1.4); 
        }

        .node-connection.connection-target { 
            transform: scale(1.5); 
            box-shadow: 0 0 16px #10b981; 
            background: #10b981 !important; 
            border-color: #ffffff; 
        }

        @keyframes connection-pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px currentColor; }
            50% { opacity: 0.7; box-shadow: 0 0 20px currentColor; }
        }

        .node-input { 
            background: #6366f1; 
            top: 50%; 
            left: -8px; 
            transform: translateY(-50%); 
        }

        .node-output-success { 
            background: #10b981; 
            top: 30%; 
            right: -8px; 
            transform: translateY(-50%); 
        }

        .node-output-error { 
            background: #ef4444; 
            bottom: 30%; 
            right: -8px; 
            transform: translateY(50%); 
        }

        /* Enhanced Connection Lines */
        .connection-line {
            stroke-width: 3;
            fill: none;
            cursor: pointer;
            transition: all 0.25s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .connection-line:hover { 
            stroke-width: 5; 
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2)); 
        }

        .connection-success { stroke: #10b981; }
        .connection-error { stroke: #ef4444; stroke-dasharray: 10,5; }
        .temp-connection { 
            stroke-opacity: 0.7; 
            stroke-dasharray: 6,6; 
            animation: temp-connection-flow 1s linear infinite; 
        }

        @keyframes temp-connection-flow {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: 12; }
        }

        .connection-label {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            pointer-events: none;
            fill: #ffffff;
            stroke: rgba(0,0,0,0.8);
            stroke-width: 2;
            paint-order: stroke fill;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }

        .label-success { fill: #10b981; }
        .label-error { fill: #ef4444; }

        /* Enhanced Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 30;
        }

        .zoom-btn {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.95);
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            backdrop-filter: blur(8px);
            font-weight: bold;
            font-size: 14px;
        }

        .zoom-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            transform: scale(1.05);
        }

        .zoom-level {
            text-align: center;
            font-size: 11px;
            color: #6b7280;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 6px;
            border-radius: 4px;
            backdrop-filter: blur(8px);
            font-weight: 500;
        }

        /* Enhanced Fullscreen Controls */
        .fullscreen-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 40;
            display: flex;
            gap: 6px;
        }

        .fullscreen-btn {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: #ffffff;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            backdrop-filter: blur(8px);
        }

        .fullscreen-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            transform: scale(1.05);
        }

        .fullscreen-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Enhanced Form Styles */
        .form-container {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-group input, .form-group textarea, .form-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.25s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 2px solid #f1f5f9;
        }

        /* Enhanced Button Styles */
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 2px solid;
            font-size: 13px;
        }

        .btn-primary { 
            background: #3b82f6; 
            color: #ffffff; 
            border-color: #3b82f6; 
        }

        .btn-primary:hover { 
            background: #2563eb; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); 
        }

        .btn-success { 
            background: #10b981; 
            color: #ffffff; 
            border-color: #10b981; 
        }

        .btn-success:hover { 
            background: #059669; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); 
        }

        .btn-secondary { 
            background: #6b7280; 
            color: #ffffff; 
            border-color: #6b7280; 
        }

        .btn-secondary:hover { 
            background: #4b5563; 
            transform: translateY(-1px); 
        }

        .btn-danger { 
            background: #ef4444; 
            color: #ffffff; 
            border-color: #ef4444; 
        }

        .btn-danger:hover { 
            background: #dc2626; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); 
        }

        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Enhanced Scenario Cards */
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .scenario-card {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.25s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scenario-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .card-header h3 { 
            font-size: 17px; 
            font-weight: 700; 
            color: #1f2937; 
            margin: 0; 
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.public { 
            background: #dcfce7; 
            color: #166534; 
        }

        .status-badge.private { 
            background: #fee2e2; 
            color: #991b1b; 
        }

        .scenario-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .info-item i { 
            color: #9ca3af; 
            width: 14px; 
        }

        .card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #f3f4f6;
        }

        /* Enhanced Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #ffffff;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content.large { max-width: 1300px; }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
        }

        .modal-header h3 { 
            margin: 0; 
            color: #1f2937; 
            font-size: 18px; 
            font-weight: 700; 
        }

        .close {
            color: #9ca3af;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.25s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .close:hover { 
            color: #ef4444; 
            background: #fef2f2; 
        }

        .modal-body { 
            padding: 24px; 
            max-height: 70vh; 
            overflow-y: auto; 
        }

        /* Enhanced Flash Messages */
        .flash-messages {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-success { 
            background: #dcfce7; 
            color: #166534; 
            border-left: 4px solid #10b981; 
        }

        .alert-error { 
            background: #fee2e2; 
            color: #991b1b; 
            border-left: 4px solid #ef4444; 
        }

        .alert-info { 
            background: #dbeafe; 
            color: #1e40af; 
            border-left: 4px solid #3b82f6; 
        }

        .close-alert {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
            margin-left: auto;
            opacity: 0.7;
            transition: opacity 0.25s ease;
        }

        .close-alert:hover { opacity: 1; }

        /* Enhanced Responsive Design */
        @media (max-width: 1400px) {
            .workflow-editor { height: 80vh; }
            .workflow-sidebar { width: 280px; }
            .node-properties { width: 350px; }
            .workflow-canvas { left: 280px; right: 350px; }
        }

        @media (max-width: 1200px) {
            .workflow-editor { height: 75vh; }
            .workflow-sidebar { width: 260px; }
            .node-properties { width: 330px; }
            .workflow-canvas { left: 260px; right: 330px; }
            .form-row { grid-template-columns: 1fr; gap: 16px; }
            .scenarios-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 1024px) {
            .workflow-editor { height: 70vh; }
            .workflow-sidebar { width: 240px; }
            .node-properties { width: 310px; }
            .workflow-canvas { left: 240px; right: 310px; }
            .workflow-node { min-width: 170px; font-size: 12px; padding: 14px; }
        }

        @media (max-width: 768px) {
            .workflow-sidebar { width: 220px; }
            .node-properties { width: 290px; }
            .workflow-canvas { left: 220px; right: 290px; }
            .workflow-node { min-width: 150px; font-size: 11px; padding: 12px; }
            .workflow-toolbar { padding: 0 15px; gap: 8px; }
            .toolbar-btn { padding: 6px 10px; font-size: 12px; }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Accessibility */
        .workflow-node:focus, 
        .palette-item:focus, 
        .toolbar-btn:focus,
        .btn:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Version Badge */
        .version-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-project-diagram"></i> 
                    Enhanced Visual Automation Workflow Editor
                    <span class="version-badge">v2.0</span>
                </h1>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                        <span>Welcome, {{ session.username }}</span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </header>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                            <span>{{ message }}</span>
                            <button class="close-alert">&times;</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Main Content -->
        <main class="main-content">
            <!-- Workflow Creation Section -->
            <section class="create-section">
                <div class="section-header">
                    <h2><i class="fas fa-magic"></i> Create Enhanced Visual Automation Workflow</h2>
                    <div class="header-actions">
                        <button id="toggleWorkflowEditor" class="btn btn-primary">
                            <i class="fas fa-plus"></i> New Workflow
                        </button>
                    </div>
                </div>

                <div id="workflowEditorContainer" class="form-container" style="display: none;">
                    <form id="workflowForm" method="POST" action="{{ url_for('web_create_scenario') }}">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="workflowName">
                                    <i class="fas fa-tag"></i> Workflow Name
                                </label>
                                <input type="text" id="workflowName" name="name" required maxlength="100" 
                                       placeholder="Enter workflow name...">
                            </div>
                            <div class="form-group">
                                <label for="workflowDescription">
                                    <i class="fas fa-align-left"></i> Description
                                </label>
                                <textarea id="workflowDescription" name="description" rows="2" maxlength="500" 
                                          placeholder="Describe what this workflow does..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="is_public" id="workflowIsPublic">
                                    <i class="fas fa-globe"></i> Make Public
                                </label>
                            </div>
                        </div>

                        <!-- Enhanced Visual Workflow Editor -->
                        <div class="workflow-editor" id="workflowEditor">
                            <!-- Left Sidebar - Enhanced Node Palette -->
                            <div class="workflow-sidebar">
                                <h3><i class="fas fa-puzzle-piece"></i> <span>Components Library</span></h3>
                                
                                <div class="node-palette">
                                    <!-- Basic Actions -->
                                    <div class="palette-section">
                                        <div class="palette-section-title">
                                            <i class="fas fa-play-circle"></i> Basic Actions
                                        </div>
                                        <div class="palette-item basic" data-node-type="open_browser" draggable="true">
                                            <i class="fas fa-globe"></i><span>Open Browser</span>
                                        </div>
                                        <div class="palette-item basic" data-node-type="wait" draggable="true">
                                            <i class="fas fa-clock"></i><span>Wait</span>
                                        </div>
                                        <div class="palette-item basic" data-node-type="wait_element" draggable="true">
                                            <i class="fas fa-search"></i><span>Wait for Element</span>
                                        </div>
                                    </div>

                                    <!-- Navigation Nodes (NEW) -->
                                    <div class="palette-section">
                                        <div class="palette-section-title">
                                            <i class="fas fa-compass"></i> Navigation
                                        </div>
                                        <div class="palette-item navigation" data-node-type="new_tab" draggable="true">
                                            <i class="fas fa-plus-square"></i><span>New Tab</span>
                                        </div>
                                        <div class="palette-item navigation" data-node-type="activate_tab" draggable="true">
                                            <i class="fas fa-window-restore"></i><span>Activate Tab</span>
                                        </div>
                                        <div class="palette-item navigation" data-node-type="open_url" draggable="true">
                                            <i class="fas fa-external-link-alt"></i><span>Open URL</span>
                                        </div>
                                        <div class="palette-item navigation" data-node-type="close_tab" draggable="true">
                                            <i class="fas fa-times-circle"></i><span>Close Tab</span>
                                        </div>
                                        <div class="palette-item navigation" data-node-type="go_back" draggable="true">
                                            <i class="fas fa-arrow-left"></i><span>Go Back</span>
                                        </div>
                                        <div class="palette-item navigation" data-node-type="reload_page" draggable="true">
                                            <i class="fas fa-redo"></i><span>Reload Page</span>
                                        </div>
                                    </div>

                                    <!-- User Interactions (Enhanced) -->
                                    <div class="palette-section">
                                        <div class="palette-section-title">
                                            <i class="fas fa-hand-pointer"></i> User Interactions
                                        </div>
                                        <div class="palette-item interaction" data-node-type="click" draggable="true">
                                            <i class="fas fa-mouse-pointer"></i><span>Click Element</span>
                                        </div>
                                        <div class="palette-item interaction" data-node-type="type_text" draggable="true">
                                            <i class="fas fa-keyboard"></i><span>Type Text</span>
                                        </div>
                                        <div class="palette-item interaction" data-node-type="scroll" draggable="true">
                                            <i class="fas fa-scroll"></i><span>Scroll Page</span>
                                        </div>
                                    </div>

                                    <!-- Keyboard Actions (NEW) -->
                                    <div class="palette-section">
                                        <div class="palette-section-title">
                                            <i class="fas fa-keyboard"></i> Keyboard Actions
                                        </div>
                                        <div class="palette-item keyboard" data-node-type="press_key" draggable="true">
                                            <i class="fas fa-keyboard"></i><span>Press Key</span>
                                        </div>
                                    </div>

                                    <!-- Data Operations (NEW) -->
                                    <div class="palette-section">
                                        <div class="palette-section-title">
                                            <i class="fas fa-database"></i> Data Operations
                                        </div>
                                        <div class="palette-item data" data-node-type="element_exists" draggable="true">
                                            <i class="fas fa-search-plus"></i><span>Element Exists</span>
                                        </div>
                                        <div class="palette-item data" data-node-type="get_text" draggable="true">
                                            <i class="fas fa-font"></i><span>Get Text</span>
                                        </div>
                                    </div>

                                    <!-- Control Flow -->
                                    <div class="palette-section">
                                        <div class="palette-section-title">
                                            <i class="fas fa-code-branch"></i> Control Flow
                                        </div>
                                        <div class="palette-item control" data-node-type="condition" draggable="true">
                                            <i class="fas fa-code-branch"></i><span>Condition</span>
                                        </div>
                                        <div class="palette-item control" data-node-type="loop" draggable="true">
                                            <i class="fas fa-sync"></i><span>Loop</span>
                                        </div>
                                        <div class="palette-item control" data-node-type="javascript" draggable="true">
                                            <i class="fas fa-code"></i><span>JavaScript</span>
                                        </div>
                                    </div>

                                    <!-- File Operations -->
                                    <div class="palette-section">
                                        <div class="palette-section-title">
                                            <i class="fas fa-folder-open"></i> File Operations
                                        </div>
                                        <div class="palette-item file" data-node-type="upload" draggable="true">
                                            <i class="fas fa-upload"></i><span>Upload File</span>
                                        </div>
                                        <div class="palette-item file" data-node-type="download" draggable="true">
                                            <i class="fas fa-download"></i><span>Download File</span>
                                        </div>
                                        <div class="palette-item file" data-node-type="screenshot" draggable="true">
                                            <i class="fas fa-camera"></i><span>Take Screenshot</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Floating Toolbar -->
                            <div class="workflow-toolbar">
                                <button type="button" class="toolbar-btn" id="clearWorkflow">
                                    <i class="fas fa-trash-alt"></i><span>Clear</span>
                                </button>
                                <button type="button" class="toolbar-btn" id="validateWorkflow">
                                    <i class="fas fa-check-double"></i><span>Validate</span>
                                </button>
                                <button type="button" class="toolbar-btn" id="autoLayout">
                                    <i class="fas fa-magic"></i><span>Auto Layout</span>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn" id="exportWorkflow">
                                    <i class="fas fa-file-export"></i><span>Export</span>
                                </button>
                                <button type="button" class="toolbar-btn" id="importWorkflow">
                                    <i class="fas fa-file-import"></i><span>Import</span>
                                </button>
                                <div class="workflow-stats">
                                    <span><i class="fas fa-project-diagram"></i><span id="nodeCount">Nodes: 0</span></span>
                                    <span><i class="fas fa-link"></i><span id="connectionCount">Connections: 0</span></span>
                                </div>
                            </div>

                            <!-- Enhanced Fullscreen Controls -->
                            <div class="fullscreen-controls">
                                <button class="fullscreen-btn" id="toggleFullscreen" title="Toggle Fullscreen">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <button class="fullscreen-btn" id="toggleCompact" title="Toggle Compact Mode">
                                    <i class="fas fa-compress-arrows-alt"></i>
                                </button>
                                <button class="fullscreen-btn" id="resetLayout" title="Reset Layout">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>

                            <!-- Enhanced Zoom Controls -->
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                                <div class="zoom-level" id="zoomLevel">100%</div>
                                <button class="zoom-btn" id="zoomOut" title="Zoom Out">-</button>
                                <button class="zoom-btn" id="zoomReset" title="Reset Zoom">
                                    <i class="fas fa-expand-arrows-alt"></i>
                                </button>
                            </div>

                            <!-- Enhanced Canvas Area -->
                            <div class="workflow-canvas" id="workflowCanvas">
                                <div class="canvas-container" id="canvasContainer">
                                    <svg id="connectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                                        <defs>
                                            <marker id="arrowSuccess" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                                <path d="M0,0 L0,6 L9,3 z" fill="#10b981"/>
                                            </marker>
                                            <marker id="arrowError" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                                <path d="M0,0 L0,6 L9,3 z" fill="#ef4444"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>

                            <!-- Enhanced Properties Panel -->
                            <div class="node-properties" id="nodeProperties">
                                <h3><i class="fas fa-cogs"></i> <span>Node Properties</span></h3>
                                <div id="propertiesContent">
                                    <div style="text-align: center; padding: 40px 0; color: #9ca3af;">
                                        <i class="fas fa-mouse-pointer fa-2x" style="margin-bottom: 16px; display: block;"></i>
                                        <p>Select a node to edit its properties</p>
                                        <div style="margin-top: 20px; font-size: 12px; color: #6b7280;">
                                            <p><strong>ðŸš€ New in v2.0:</strong></p>
                                            <p>â€¢ Enhanced navigation controls</p>
                                            <p>â€¢ Advanced keyboard interactions</p>
                                            <p>â€¢ Data extraction capabilities</p>
                                            <p>â€¢ Multi-tab browser support</p>
                                            <p>â€¢ Variable system</p>
                                            <hr style="margin: 12px 0; border-color: #e5e7eb;">
                                            <p><strong>Quick Tips:</strong></p>
                                            <p>â€¢ Drag nodes from the left palette</p>
                                            <p>â€¢ Click nodes to select and edit</p>
                                            <p>â€¢ Drag from connection points to link nodes</p>
                                            <p>â€¢ Double-click connections to remove</p>
                                            <p>â€¢ Use mouse wheel to zoom</p>
                                            <p>â€¢ Drag empty space to pan</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="steps" id="workflowData">

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Workflow
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelWorkflowCreate()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Enhanced Existing Workflows Section -->
            <section class="scenarios-section">
                <div class="section-header">
                    <h2><i class="fas fa-folder-open"></i> Available Workflows</h2>
                    <div class="filter-controls">
                        <select id="filterType" onchange="filterScenarios()" class="form-select">
                            <option value="all">All Workflows</option>
                            <option value="public">Public Only</option>
                            <option value="private">My Private</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshWorkflows()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="scenarios-grid" id="scenariosGrid">
                    {% for scenario in scenarios %}
                    <div class="scenario-card" data-public="{{ scenario.is_public }}" data-id="{{ scenario.id }}">
                        <div class="card-header">
                            <h3>{{ scenario.name }}</h3>
                            <div class="card-status">
                                {% if scenario.is_public %}
                                    <span class="status-badge public">
                                        <i class="fas fa-globe"></i> Public
                                    </span>
                                {% else %}
                                    <span class="status-badge private">
                                        <i class="fas fa-lock"></i> Private
                                    </span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card-body">
                            <p class="description">{{ scenario.description or 'No description provided' }}</p>
                            
                            <div class="scenario-info">
                                <div class="info-item">
                                    <i class="fas fa-user"></i>
                                    <span>{{ scenario.creator_name or 'Unknown' }}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>{{ scenario.updated_at[:10] }}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-project-diagram"></i>
                                    <span id="nodeCount{{ scenario.id }}">
                                        <div class="loading"></div>
                                    </span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-link"></i>
                                    <span id="connectionCount{{ scenario.id }}">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="card-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewWorkflow({{ scenario.id }})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            {% if scenario.created_by == session.user_id %}
                                <button class="btn btn-success btn-sm" onclick="editWorkflow({{ scenario.id }})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="duplicateWorkflow({{ scenario.id }})">
                                    <i class="fas fa-copy"></i> Duplicate
                                </button>
                                <form method="POST" action="{{ url_for('web_update_scenario', scenario_id=scenario.id) }}" style="display: inline;">
                                    <input type="hidden" name="action" value="toggle_public">
                                    <button type="submit" class="btn btn-secondary btn-sm" title="Toggle Visibility">
                                        {% if scenario.is_public %}
                                            <i class="fas fa-eye-slash"></i>
                                        {% else %}
                                            <i class="fas fa-globe"></i>
                                        {% endif %}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('web_update_scenario', scenario_id=scenario.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('âš ï¸ Are you sure you want to delete this workflow?')">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-danger btn-sm" title="Delete Workflow">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if not scenarios %}
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <i class="fas fa-project-diagram fa-4x" style="margin-bottom: 24px; color: #d1d5db;"></i>
                    <h3 style="color: #374151; margin-bottom: 12px;">No Workflows Available</h3>
                    <p style="font-size: 16px; margin-bottom: 24px;">Create your first enhanced automation workflow with the new v2.0 features!</p>
                    <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin: 0 0 8px 0;">âœ¨ New in v2.0:</h4>
                        <ul style="text-align: left; color: #1e40af; margin: 0; font-size: 14px;">
                            <li>Multi-tab browser navigation</li>
                            <li>Advanced keyboard shortcuts</li>
                            <li>Data extraction & variables</li>
                            <li>Enhanced error handling</li>
                            <li>Improved visual editor</li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="document.getElementById('toggleWorkflowEditor').click()">
                        <i class="fas fa-plus"></i> Create Enhanced Workflow
                    </button>
                </div>
                {% endif %}
            </section>
        </main>
    </div>

    <!-- Enhanced Modals -->
    <div id="workflowViewModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="workflowViewTitle"><i class="fas fa-project-diagram"></i> Enhanced Workflow Details</h3>
                <span class="close" onclick="closeModal('workflowViewModal')">&times;</span>
            </div>
            <div class="modal-body" id="workflowViewBody"></div>
        </div>
    </div>

    <!-- Edit Workflow Modal -->
    <div id="editWorkflowModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Enhanced Workflow</h3>
                <span class="close" onclick="closeModal('editWorkflowModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editWorkflowForm" method="POST">
                    <input type="hidden" name="action" value="update">
                    <input type="hidden" id="editScenarioId" name="id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editWorkflowName">
                                <i class="fas fa-tag"></i> Workflow Name
                            </label>
                            <input type="text" id="editWorkflowName" name="name" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="editWorkflowDescription">
                                <i class="fas fa-align-left"></i> Description
                            </label>
                            <textarea id="editWorkflowDescription" name="description" rows="2" maxlength="500"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="is_public" id="editWorkflowIsPublic">
                                <i class="fas fa-globe"></i> Make Public
                            </label>
                        </div>
                    </div>

                    <!-- Enhanced Visual Workflow Editor for Edit -->
                    <div class="workflow-editor" id="editWorkflowEditor">
                        <!-- Left Sidebar - Enhanced Node Palette -->
                        <div class="workflow-sidebar">
                            <h3><i class="fas fa-puzzle-piece"></i> <span>Components Library</span></h3>
                            
                            <div class="node-palette">
                                <!-- Basic Actions -->
                                <div class="palette-section">
                                    <div class="palette-section-title">
                                        <i class="fas fa-play-circle"></i> Basic Actions
                                    </div>
                                    <div class="palette-item basic" data-node-type="open_browser" draggable="true">
                                        <i class="fas fa-globe"></i><span>Open Browser</span>
                                    </div>
                                    <div class="palette-item basic" data-node-type="wait" draggable="true">
                                        <i class="fas fa-clock"></i><span>Wait</span>
                                    </div>
                                    <div class="palette-item basic" data-node-type="wait_element" draggable="true">
                                        <i class="fas fa-search"></i><span>Wait for Element</span>
                                    </div>
                                </div>

                                <!-- Navigation Nodes (NEW) -->
                                <div class="palette-section">
                                    <div class="palette-section-title">
                                        <i class="fas fa-compass"></i> Navigation
                                    </div>
                                    <div class="palette-item navigation" data-node-type="new_tab" draggable="true">
                                        <i class="fas fa-plus-square"></i><span>New Tab</span>
                                    </div>
                                    <div class="palette-item navigation" data-node-type="activate_tab" draggable="true">
                                        <i class="fas fa-window-restore"></i><span>Activate Tab</span>
                                    </div>
                                    <div class="palette-item navigation" data-node-type="open_url" draggable="true">
                                        <i class="fas fa-external-link-alt"></i><span>Open URL</span>
                                    </div>
                                    <div class="palette-item navigation" data-node-type="close_tab" draggable="true">
                                        <i class="fas fa-times-circle"></i><span>Close Tab</span>
                                    </div>
                                    <div class="palette-item navigation" data-node-type="go_back" draggable="true">
                                        <i class="fas fa-arrow-left"></i><span>Go Back</span>
                                    </div>
                                    <div class="palette-item navigation" data-node-type="reload_page" draggable="true">
                                        <i class="fas fa-redo"></i><span>Reload Page</span>
                                    </div>
                                </div>

                                <!-- User Interactions (Enhanced) -->
                                <div class="palette-section">
                                    <div class="palette-section-title">
                                        <i class="fas fa-hand-pointer"></i> User Interactions
                                    </div>
                                    <div class="palette-item interaction" data-node-type="click" draggable="true">
                                        <i class="fas fa-mouse-pointer"></i><span>Click Element</span>
                                    </div>
                                    <div class="palette-item interaction" data-node-type="type_text" draggable="true">
                                        <i class="fas fa-keyboard"></i><span>Type Text</span>
                                    </div>
                                    <div class="palette-item interaction" data-node-type="scroll" draggable="true">
                                        <i class="fas fa-scroll"></i><span>Scroll Page</span>
                                    </div>
                                </div>

                                <!-- Keyboard Actions (NEW) -->
                                <div class="palette-section">
                                    <div class="palette-section-title">
                                        <i class="fas fa-keyboard"></i> Keyboard Actions
                                    </div>
                                    <div class="palette-item keyboard" data-node-type="press_key" draggable="true">
                                        <i class="fas fa-keyboard"></i><span>Press Key</span>
                                    </div>
                                </div>

                                <!-- Data Operations (NEW) -->
                                <div class="palette-section">
                                    <div class="palette-section-title">
                                        <i class="fas fa-database"></i> Data Operations
                                    </div>
                                    <div class="palette-item data" data-node-type="element_exists" draggable="true">
                                        <i class="fas fa-search-plus"></i><span>Element Exists</span>
                                    </div>
                                    <div class="palette-item data" data-node-type="get_text" draggable="true">
                                        <i class="fas fa-font"></i><span>Get Text</span>
                                    </div>
                                </div>

                                <!-- Control Flow -->
                                <div class="palette-section">
                                    <div class="palette-section-title">
                                        <i class="fas fa-code-branch"></i> Control Flow
                                    </div>
                                    <div class="palette-item control" data-node-type="condition" draggable="true">
                                        <i class="fas fa-code-branch"></i><span>Condition</span>
                                    </div>
                                    <div class="palette-item control" data-node-type="loop" draggable="true">
                                        <i class="fas fa-sync"></i><span>Loop</span>
                                    </div>
                                    <div class="palette-item control" data-node-type="javascript" draggable="true">
                                        <i class="fas fa-code"></i><span>JavaScript</span>
                                    </div>
                                </div>

                                <!-- File Operations -->
                                <div class="palette-section">
                                    <div class="palette-section-title">
                                        <i class="fas fa-folder-open"></i> File Operations
                                    </div>
                                    <div class="palette-item file" data-node-type="upload" draggable="true">
                                        <i class="fas fa-upload"></i><span>Upload File</span>
                                    </div>
                                    <div class="palette-item file" data-node-type="download" draggable="true">
                                        <i class="fas fa-download"></i><span>Download File</span>
                                    </div>
                                    <div class="palette-item file" data-node-type="screenshot" draggable="true">
                                        <i class="fas fa-camera"></i><span>Take Screenshot</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Floating Toolbar for Edit -->
                        <div class="workflow-toolbar">
                            <button type="button" class="toolbar-btn" id="clearEditWorkflow">
                                <i class="fas fa-trash-alt"></i><span>Clear</span>
                            </button>
                            <button type="button" class="toolbar-btn" id="validateEditWorkflow">
                                <i class="fas fa-check-double"></i><span>Validate</span>
                            </button>
                            <button type="button" class="toolbar-btn" id="autoLayoutEdit">
                                <i class="fas fa-magic"></i><span>Auto Layout</span>
                            </button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="toolbar-btn" id="exportEditWorkflow">
                                <i class="fas fa-file-export"></i><span>Export</span>
                            </button>
                            <div class="workflow-stats">
                                <span><i class="fas fa-project-diagram"></i><span id="editNodeCount">Nodes: 0</span></span>
                                <span><i class="fas fa-link"></i><span id="editConnectionCount">Connections: 0</span></span>
                            </div>
                        </div>

                        <!-- Enhanced Canvas Area for Edit -->
                        <div class="workflow-canvas" id="editWorkflowCanvas">
                            <div class="canvas-container" id="editCanvasContainer">
                                <svg id="editConnectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                                    <defs>
                                        <marker id="editArrowSuccess" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" fill="#10b981"/>
                                        </marker>
                                        <marker id="editArrowError" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" fill="#ef4444"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                        </div>

                        <!-- Enhanced Properties Panel for Edit -->
                        <div class="node-properties" id="editNodeProperties">
                            <h3><i class="fas fa-cogs"></i> <span>Node Properties</span></h3>
                            <div id="editPropertiesContent">
                                <div style="text-align: center; padding: 40px 0; color: #9ca3af;">
                                    <i class="fas fa-mouse-pointer fa-2x" style="margin-bottom: 16px; display: block;"></i>
                                    <p>Select a node to edit its properties</p>
                                    <div style="margin-top: 20px; font-size: 12px; color: #6b7280;">
                                        <p><strong>ðŸŽ¯ Edit Mode:</strong></p>
                                        <p>â€¢ Modify existing workflow</p>
                                        <p>â€¢ Add/remove nodes and connections</p>
                                        <p>â€¢ Update node properties</p>
                                        <p>â€¢ Save changes when ready</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="steps" id="editWorkflowData">

                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Update Workflow
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editWorkflowModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="importWorkflowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-import"></i> Import Enhanced Workflow</h3>
                <span class="close" onclick="closeModal('importWorkflowModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Import Method:</label>
                    <div style="display: flex; gap: 16px; margin: 16px 0;">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-file-upload"></i> Upload File
                        </button>
                        <button class="btn btn-secondary" onclick="toggleJsonInput()">
                            <i class="fas fa-code"></i> Paste JSON
                        </button>
                    </div>
                </div>
                
                <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                
                <div id="jsonInputArea" style="display: none;">
                    <div class="form-group">
                        <label>Paste Enhanced Workflow JSON:</label>
                        <textarea id="jsonInput" rows="10" class="property-input" 
                                  placeholder="Paste your enhanced workflow JSON data here..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="importFromJson()">
                        <i class="fas fa-check"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Enhanced initialization with new features
        let workflowEditor, editWorkflowEditor, uiController;

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupFlashMessages();
            
            {% for scenario in scenarios %}
                loadWorkflowPreview({{ scenario.id }}, {{ scenario.steps|tojson }});
            {% endfor %}
        });

        function initializeApp() {
            setupEventListeners();
            uiController = new UIController();
            
            // Add version info to console
            console.log('%cðŸš€ Enhanced Browser Automation v2.0', 'color: #3b82f6; font-weight: bold; font-size: 14px;');
            console.log('%câœ¨ New Features: Navigation, Keyboard, Data Extraction, Edit Workflow', 'color: #10b981; font-size: 12px;');
        }

        function setupEventListeners() {
            document.getElementById('toggleWorkflowEditor').addEventListener('click', toggleWorkflowEditor);
            document.querySelectorAll('.close-alert').forEach(btn => {
                btn.addEventListener('click', function() { this.parentElement.remove(); });
            });
            
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) e.target.style.display = 'none';
            });

            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            if (workflowEditor && document.getElementById('workflowEditorContainer').style.display !== 'none') {
                                document.getElementById('workflowForm').requestSubmit();
                            } else if (editWorkflowEditor && document.getElementById('editWorkflowModal').style.display !== 'none') {
                                document.getElementById('editWorkflowForm').requestSubmit();
                            }
                            break;
                        case 'n':
                            e.preventDefault();
                            document.getElementById('toggleWorkflowEditor').click();
                            break;
                    }
                }
            });
        }

        function setupFlashMessages() {
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.transition = 'opacity 0.5s ease';
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 500);
                });
            }, 5000);
        }

        function toggleWorkflowEditor() {
            const container = document.getElementById('workflowEditorContainer');
            const button = document.getElementById('toggleWorkflowEditor');
            
            if (container.style.display === 'none' || !container.style.display) {
                container.style.display = 'block';
                button.innerHTML = '<i class="fas fa-minus"></i> Cancel';
                button.className = 'btn btn-secondary';
                
                if (!workflowEditor) {
                    workflowEditor = new VisualWorkflowEditor();
                }
                
                container.scrollIntoView({ behavior: 'smooth' });
            } else {
                cancelWorkflowCreate();
            }
        }

        function cancelWorkflowCreate() {
            const container = document.getElementById('workflowEditorContainer');
            const button = document.getElementById('toggleWorkflowEditor');
            
            container.style.display = 'none';
            button.innerHTML = '<i class="fas fa-plus"></i> New Workflow';
            button.className = 'btn btn-primary';
            
            document.getElementById('workflowForm').reset();
            
            if (workflowEditor) {
                workflowEditor.clearWorkflow();
            }
        }

        function loadWorkflowPreview(scenarioId, stepsJson) {
            try {
                let nodeCount = 0;
                let workflowType = 'Linear';
                
                if (typeof stepsJson === 'string') {
                    const data = JSON.parse(stepsJson);
                    if (data.workflow_type === 'visual' && data.nodes) {
                        nodeCount = data.nodes.length;
                        workflowType = 'Visual v2.0';
                    } else {
                        nodeCount = Array.isArray(data) ? data.length : 0;
                    }
                } else if (Array.isArray(stepsJson)) {
                    nodeCount = stepsJson.length;
                } else if (stepsJson && stepsJson.nodes) {
                    nodeCount = stepsJson.nodes.length;
                    workflowType = 'Visual v2.0';
                }
                
                const countElement = document.getElementById('nodeCount' + scenarioId);
                if (countElement) countElement.textContent = `${nodeCount} nodes (${workflowType})`;
            } catch (error) {
                const countElement = document.getElementById('nodeCount' + scenarioId);
                if (countElement) countElement.textContent = 'Error';
            }
        }

        function viewWorkflow(scenarioId) {
            fetch(`/api/scenarios/${scenarioId}`)
                .then(response => response.json())
                .then(scenario => displayWorkflowViewer(scenario))
                .catch(error => alert('Error loading workflow details'));
        }

        // Enhanced Edit Workflow Function
        async function editWorkflow(scenarioId) {
            try {
                showLoadingModal('Loading workflow for editing...');
                
                // Fetch workflow data for editing
                const response = await fetch(`/api/scenarios/${scenarioId}/edit`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const workflowData = await response.json();
                hideLoadingModal();
                
                // Open edit modal and populate data
                openEditWorkflowModal(workflowData);
                
            } catch (error) {
                hideLoadingModal();
                console.error('Error loading workflow for edit:', error);
                alert('Error loading workflow for editing: ' + error.message);
            }
        }

        function openEditWorkflowModal(workflowData) {
            // Populate form fields
            document.getElementById('editScenarioId').value = workflowData.id;
            document.getElementById('editWorkflowName').value = workflowData.name;
            document.getElementById('editWorkflowDescription').value = workflowData.description;
            document.getElementById('editWorkflowIsPublic').checked = workflowData.is_public;
            
            // Set up form action
            const editForm = document.getElementById('editWorkflowForm');
            editForm.action = `/web/scenarios/${workflowData.id}`;
            
            // Initialize edit workflow editor
            if (!editWorkflowEditor) {
                editWorkflowEditor = new VisualWorkflowEditor();
                editWorkflowEditor.mode = 'edit';
            }
            
            // Load workflow data into editor
            if (workflowData.steps) {
                editWorkflowEditor.loadWorkflowData(workflowData.steps);
            }
            
            // Show modal
            document.getElementById('editWorkflowModal').style.display = 'block';
            
            // Setup form submission
            editForm.onsubmit = function(e) {
                e.preventDefault();
                saveEditWorkflow(workflowData.id);
            };
        }

        async function saveEditWorkflow(scenarioId) {
            try {
                showLoadingModal('Saving workflow changes...');
                
                // Get workflow data from editor
                const workflowData = editWorkflowEditor.getWorkflowData();
                document.getElementById('editWorkflowData').value = JSON.stringify(workflowData);
                
                // Create form data
                const formData = new FormData(document.getElementById('editWorkflowForm'));
                
                // Submit to server
                const response = await fetch(`/web/scenarios/${scenarioId}`, {
                    method: 'POST',
                    body: formData
                });
                
                hideLoadingModal();
                
                if (response.ok) {
                    closeModal('editWorkflowModal');
                    showSuccessMessage('Workflow updated successfully!');
                    // Refresh the page to show updated data
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error('Failed to save workflow');
                }
                
            } catch (error) {
                hideLoadingModal();
                console.error('Error saving workflow:', error);
                alert('Error saving workflow: ' + error.message);
            }
        }

        function displayWorkflowViewer(scenario) {
            document.getElementById('workflowViewTitle').innerHTML = 
                `<i class="fas fa-project-diagram"></i> ${scenario.name}`;
            
            let content = `
                <div class="workflow-details">
                    <h4>ðŸ“Š Workflow Information</h4>
                    <p><strong>Name:</strong> ${scenario.name}</p>
                    <p><strong>Description:</strong> ${scenario.description || 'No description'}</p>
                    <p><strong>Status:</strong> ${scenario.is_public ? 'ðŸŒ Public' : 'ðŸ”’ Private'}</p>
                    <p><strong>Created:</strong> ${new Date(scenario.created_at).toLocaleDateString()}</p>
            `;
            
            let workflowData = scenario.steps;
            if (typeof workflowData === 'string') {
                workflowData = JSON.parse(workflowData);
            }
            
            if (workflowData && workflowData.workflow_type === 'visual') {
                const version = workflowData.metadata?.version || '1.0';
                content += `
                    <h4>ðŸŽ¨ Enhanced Visual Workflow (v${version})</h4>
                    <p><strong>Nodes:</strong> ${workflowData.nodes?.length || 0}</p>
                    <p><strong>Connections:</strong> ${workflowData.connections?.length || 0}</p>
                    <p><strong>Start Node:</strong> ${workflowData.startNode || 'Not defined'}</p>
                `;
                
                if (workflowData.nodes) {
                    // Group nodes by type
                    const nodesByType = {};
                    workflowData.nodes.forEach(node => {
                        if (!nodesByType[node.type]) nodesByType[node.type] = [];
                        nodesByType[node.type].push(node);
                    });
                    
                    content += `<h5>ðŸ“‹ Node Summary:</h5>`;
                    content += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">`;
                    
                    Object.entries(nodesByType).forEach(([type, nodes]) => {
                        const icons = {
                            'start': 'â–¶ï¸', 'open_browser': 'ðŸŒ', 'wait': 'â±ï¸', 'wait_element': 'ðŸ”',
                            'new_tab': 'ðŸ“‘', 'activate_tab': 'ðŸ”„', 'open_url': 'ðŸ”—', 'close_tab': 'âŒ',
                            'go_back': 'â¬…ï¸', 'reload_page': 'ðŸ”„', 'click': 'ðŸ‘†', 'type_text': 'âŒ¨ï¸',
                            'scroll': 'ðŸ“œ', 'press_key': 'ðŸ”§', 'element_exists': 'ðŸ‘ï¸', 'get_text': 'ðŸ“',
                            'upload': 'ðŸ“¤', 'download': 'ðŸ“¥', 'screenshot': 'ðŸ“·', 'javascript': 'ðŸ’»',
                            'condition': 'ðŸ”€', 'loop': 'ðŸ”„'
                        };
                        const icon = icons[type] || 'âš™ï¸';
                        content += `
                            <div style="background: #f8fafc; padding: 8px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                <strong>${icon} ${type.replace(/_/g, ' ').toUpperCase()}</strong><br>
                                <small>${nodes.length} node${nodes.length > 1 ? 's' : ''}</small>
                            </div>
                        `;
                    });
                    content += `</div>`;
                }

                if (workflowData.connections && workflowData.connections.length > 0) {
                    const successConnections = workflowData.connections.filter(c => c.type === 'success').length;
                    const errorConnections = workflowData.connections.filter(c => c.type === 'error').length;
                    
                    content += `<h5>ðŸ”— Connection Details:</h5>`;
                    content += `<p>âœ… Success paths: ${successConnections} | âŒ Error paths: ${errorConnections}</p>`;
                }
            } else {
                content += `
                    <h4>ðŸ“‹ Linear Workflow (Legacy)</h4>
                    <p><strong>Steps:</strong> ${Array.isArray(workflowData) ? workflowData.length : 0}</p>
                    <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border-left: 3px solid #f59e0b; margin: 10px 0;">
                        <strong>ðŸ’¡ Upgrade Tip:</strong> Convert this to Visual Workflow v2.0 for enhanced features!
                    </div>
                `;
            }
            
            content += `</div>`;
            
            document.getElementById('workflowViewBody').innerHTML = content;
            document.getElementById('workflowViewModal').style.display = 'block';
        }

        function filterScenarios() {
            const filterType = document.getElementById('filterType').value;
            const scenarioCards = document.querySelectorAll('.scenario-card');
            
            scenarioCards.forEach(card => {
                const isPublic = card.getAttribute('data-public') === 'True';
                let show = filterType === 'all' || 
                          (filterType === 'public' && isPublic) || 
                          (filterType === 'private' && !isPublic);
                
                card.style.display = show ? 'block' : 'none';
            });
        }

        function refreshWorkflows() { window.location.reload(); }
        
        function duplicateWorkflow(scenarioId) { 
            if (confirm('Create a copy of this enhanced workflow?')) {
                console.log('Duplicating enhanced workflow:', scenarioId);
                // Implementation would be added here
            }
        }
        
        function toggleJsonInput() { 
            const area = document.getElementById('jsonInputArea'); 
            area.style.display = area.style.display === 'none' ? 'block' : 'none'; 
        }
        
        function closeModal(modalId) { 
            document.getElementById(modalId).style.display = 'none';
            
            // Clean up edit workflow editor if closing edit modal
            if (modalId === 'editWorkflowModal' && editWorkflowEditor) {
                editWorkflowEditor.clearWorkflow();
            }
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (workflowEditor) workflowEditor.importWorkflow(data);
                        closeModal('importWorkflowModal');
                    } catch (error) {
                        alert('Invalid JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            } else {
                alert('Please select a valid JSON file');
            }
        }

        function importFromJson() {
            const jsonText = document.getElementById('jsonInput').value.trim();
            if (jsonText) {
                try {
                    const data = JSON.parse(jsonText);
                    if (workflowEditor) workflowEditor.importWorkflow(data);
                    closeModal('importWorkflowModal');
                } catch (error) {
                    alert('Invalid JSON: ' + error.message);
                }
            } else {
                alert('Please paste valid JSON data');
            }
        }

        // Enhanced Utility Functions
        function showLoadingModal(message) {
            // Create and show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.id = 'loadingModal';
            loadingModal.className = 'modal';
            loadingModal.style.display = 'block';
            loadingModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <div class="modal-body" style="padding: 40px;">
                        <div class="loading" style="margin: 0 auto 20px;"></div>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);
        }

        function hideLoadingModal() {
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.remove();
            }
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
                <button class="close-alert">&times;</button>
            `;
            
            let flashContainer = document.querySelector('.flash-messages');
            if (!flashContainer) {
                flashContainer = document.createElement('div');
                flashContainer.className = 'flash-messages';
                document.body.appendChild(flashContainer);
            }
            
            flashContainer.appendChild(successDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                successDiv.style.opacity = '0';
                setTimeout(() => successDiv.remove(), 300);
            }, 3000);
            
            // Add click handler for close button
            successDiv.querySelector('.close-alert').addEventListener('click', function() {
                successDiv.remove();
            });
        }

        // Enhanced UI Controller Class
        class UIController {
            constructor() {
                this.isFullscreen = false;
                this.sidebarCollapsed = false;
                this.propertiesCollapsed = false;
                this.init();
            }

            init() {
                this.setupToggleButtons();
                this.setupKeyboardShortcuts();
                this.setupEnhancedFeatures();
            }

            setupEnhancedFeatures() {
                // Add enhanced tooltips
                document.querySelectorAll('[title]').forEach(el => {
                    el.addEventListener('mouseenter', this.showTooltip);
                    el.addEventListener('mouseleave', this.hideTooltip);
                });
            }

            showTooltip(e) {
                // Enhanced tooltip implementation
                const tooltip = document.createElement('div');
                tooltip.className = 'enhanced-tooltip';
                tooltip.textContent = e.target.getAttribute('title');
                tooltip.style.cssText = `
                    position: absolute;
                    background: #1f2937;
                    color: white;
                    padding: 6px 10px;
                    border-radius: 6px;
                    font-size: 12px;
                    z-index: 9999;
                    pointer-events: none;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(tooltip);
                
                const rect = e.target.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 8) + 'px';
            }

            hideTooltip(e) {
                const tooltip = document.querySelector('.enhanced-tooltip');
                if (tooltip) tooltip.remove();
            }

            setupToggleButtons() {
                const sidebar = document.querySelector('.workflow-sidebar');
                const properties = document.querySelector('.node-properties');
                
                if (sidebar && !sidebar.querySelector('.sidebar-toggle')) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'sidebar-toggle';
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    toggleBtn.onclick = () => this.toggleSidebar();
                    sidebar.parentNode.appendChild(toggleBtn);
                }

                if (properties && !properties.querySelector('.properties-toggle')) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'properties-toggle';
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    toggleBtn.onclick = () => this.toggleProperties();
                    properties.parentNode.appendChild(toggleBtn);
                }

                // Enhanced fullscreen controls
                const fullscreenControls = document.getElementById('toggleFullscreen');
                const compactControls = document.getElementById('toggleCompact');
                const resetControls = document.getElementById('resetLayout');
                
                if (fullscreenControls) fullscreenControls.onclick = () => this.toggleFullscreen();
                if (compactControls) compactControls.onclick = () => this.toggleCompactMode();
                if (resetControls) resetControls.onclick = () => this.resetLayout();
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.workflow-sidebar');
                const editor = document.querySelector('.workflow-editor');
                
                this.sidebarCollapsed = !this.sidebarCollapsed;
                
                sidebar?.classList.toggle('collapsed', this.sidebarCollapsed);
                editor?.classList.toggle('sidebar-collapsed', this.sidebarCollapsed);
                
                this.updateCanvasLayout();
            }

            toggleProperties() {
                const properties = document.querySelector('.node-properties');
                const editor = document.querySelector('.workflow-editor');
                
                this.propertiesCollapsed = !this.propertiesCollapsed;
                
                properties?.classList.toggle('collapsed', this.propertiesCollapsed);
                editor?.classList.toggle('properties-collapsed', this.propertiesCollapsed);
                
                this.updateCanvasLayout();
            }

            toggleFullscreen() {
                const editor = document.querySelector('.workflow-editor');
                const fullscreenIcon = document.querySelector('#toggleFullscreen i');
                
                this.isFullscreen = !this.isFullscreen;
                
                editor?.classList.toggle('fullscreen', this.isFullscreen);
                if (fullscreenIcon) {
                    fullscreenIcon.className = this.isFullscreen ? 'fas fa-compress' : 'fas fa-expand';
                }
                document.body.style.overflow = this.isFullscreen ? 'hidden' : 'auto';
                
                this.updateCanvasLayout();
            }

            toggleCompactMode() {
                const toolbar = document.querySelector('.workflow-toolbar');
                const editor = document.querySelector('.workflow-editor');
                
                toolbar?.classList.toggle('compact');
                editor?.classList.toggle('compact-sidebar');
            }

            resetLayout() {
                const editor = document.querySelector('.workflow-editor');
                const sidebar = document.querySelector('.workflow-sidebar');
                const properties = document.querySelector('.node-properties');
                const toolbar = document.querySelector('.workflow-toolbar');
                
                this.isFullscreen = false;
                this.sidebarCollapsed = false;
                this.propertiesCollapsed = false;
                
                editor?.classList.remove('fullscreen', 'sidebar-collapsed', 'properties-collapsed', 'both-collapsed', 'compact-sidebar');
                sidebar?.classList.remove('collapsed');
                properties?.classList.remove('collapsed', 'expanded');
                toolbar?.classList.remove('compact');
                
                document.body.style.overflow = 'auto';
                const fullscreenIcon = document.querySelector('#toggleFullscreen i');
                if (fullscreenIcon) fullscreenIcon.className = 'fas fa-expand';
                
                this.updateCanvasLayout();
            }

            updateCanvasLayout() {
                const editor = document.querySelector('.workflow-editor');
                editor?.classList.toggle('both-collapsed', this.sidebarCollapsed && this.propertiesCollapsed);
                
                if (window.workflowEditor) {
                    setTimeout(() => workflowEditor.updateAllConnections(), 300);
                }
                if (window.editWorkflowEditor) {
                    setTimeout(() => editWorkflowEditor.updateAllConnections(), 300);
                }
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    if (e.key === 'F11') {
                        e.preventDefault();
                        this.toggleFullscreen();
                    } else if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'm': e.preventDefault(); this.toggleCompactMode(); break;
                            case 'r': e.preventDefault(); this.resetLayout(); break;
                            case '[': e.preventDefault(); this.toggleSidebar(); break;
                            case ']': e.preventDefault(); this.toggleProperties(); break;
                        }
                    }
                });
            }
        }

        // Enhanced Error Handling
        window.addEventListener('error', function(e) {
            console.error('ðŸš¨ Enhanced Workflow Editor Error:', e.error);
        });

        // Enhanced Performance Monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    const loadTime = Math.round(perfData.loadEventEnd - perfData.loadEventStart);
                    console.log(`ðŸš€ Enhanced Editor loaded in ${loadTime}ms`);
                    
                    if (loadTime > 1000) {
                        console.warn('âš ï¸ Slow loading detected. Consider optimizing resources.');
                    }
                }, 0);
            });
        }
    </script>
</body>
</html>
